services:
  db:
    image: postgres:15-alpine
    container_name: mailto-db
    environment:
      POSTGRES_USER: mailto_user
      POSTGRES_PASSWORD: mailto_password
      POSTGRES_DB: mailto_db
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data

  redis:
    image: redis:alpine
    container_name: mailto-redis
    ports:
      - "6379:6379"

  api:
    build:
      context: .
      dockerfile: src/Mailto.Api/Dockerfile
    container_name: mailto-api
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ConnectionStrings__DefaultConnection=Host=db;Database=mailto_db;Username=mailto_user;Password=mailto_password
      - Redis__ConnectionString=redis:6379
    depends_on:
      - db
      - redis
    ports:
      - "5000:8080"

  ui:
    build:
      context: .
      dockerfile: src/Mailto.UI/Dockerfile
    container_name: mailto-ui
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - Api__BaseUrl=http://api:8080
    depends_on:
      - api
    ports:
      - "80:8080"

  worker:
    build:
      context: .
      dockerfile: src/Mailto.Worker/Dockerfile
    container_name: mailto-worker
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ConnectionStrings__DefaultConnection=Host=db;Database=mailto_db;Username=mailto_user;Password=mailto_password
    depends_on:
      - db

volumes:
  postgres_data:
